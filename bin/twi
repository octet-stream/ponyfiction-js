#!/usr/bin/env node

"use strict";

const fs = require("fs");
const childProcess = require("child_process");
const join = require("path").join;

const TWI_ROOT =  join(__dirname, "../");
const execSync = childProcess.execSync;

process.title = "twi";
process.chdir(TWI_ROOT); // Change process.cwd() to Twi root path

// Install deps before continue
try {
  fs.statSync(`${TWI_ROOT}/node_modules`);
} catch (err) {
  if (err.code !== "ENOENT") {
    throw err;
  }

  execSync("npm install", {
    encoding: "utf-8",
    stdio: "inherit"
  });
}

// And then we can use deps from NPM
const commander = require("commander");
const ora = require("ora")();
const pify = require("pify");
const exec = pify(childProcess.exec);

function onError(err) {
  ora.text = String(err);
  ora.fail();
  console.log("");
  process.exit(1);
}

function onFulfilled() {
  ora.text = "Done without errors...";
  ora.succeed();
  process.exit(0);
}

function runSetup(cmd) {
  // try {
  //   console.log("Make backend app...");
  //   execSync(`${TWI_ROOT}/node_modules/coffee-script/bin/cake make`);

  //   console.log("Make frontend app...");
  //   execSync(`${TWI_ROOT}/node_modules/gulp/bin/gulp.js`);

  // } catch (err) {
  //   console.log(err);
  //   process.exit(1);
  // }

  ora.color = "cyan";
  ora.text = "Making backend app...";
  ora.start();
  exec(`${TWI_ROOT}/node_modules/coffee-script/bin/cake make`)
    .then(() => {
      ora.color = "yellow";
      ora.text = "Making frontend app...";
      return exec(`${TWI_ROOT}/node_modules/gulp/bin/gulp.js`);
    })
    .then(onFulfilled, onError);

  // const setup = require(`${TWI_ROOT}/setup/setup`);
  // var __fulfill;

  // if (cmd.S === true) {
  //   __fulfill = setup.silent(cmd.C);
  // } else if (cmd.C === true) {
  //   __fulfill = setup.clean();
  // } else {
  //   __fulfill = setup();
  // }

  // __fulfill.then(onFulfilled, onError);
}

commander
  .version(require(`${TWI_ROOT}/package.json`).version)
  .usage("<command> [options]");

commander
  .command("setup")
  .description("run installer script")
  .option("--silent, -s", "run installer in silent mode")
  .option("--clean, -s", "run installer in clean mode")
  .action(runSetup);

commander
  .command("run")
  .description("run Twi app")
  .action(() => require(`${TWI_ROOT}/core/server`));

commander.parse(process.argv);
process.on("error", onError);
