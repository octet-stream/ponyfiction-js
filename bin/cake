#!/usr/bin/env node

const {dirname, extname, resolve, isAbsolute} = require("path")
const fs = require ("fs")

const {ROOT, tryDeps} = require("./helper")

tryDeps() // Check deps before including external packages

const commander = require("commander")
const {cross, tick, pointer} = require("figures")
const vfs = require("vinyl-fs")
const ora = require("ora")()
const glob = require("glob")
const junk = require("junk")
const rimraf = require("rimraf")
const through = require("through2")
const {red, green, cyan} = require("chalk")

const {
  compile, FILE_EXTENSIONS
} = require(`${ROOT}/node_modules/coffee-script`)

const {transform} = require(`${ROOT}/node_modules/coffee-react`)

const DEFAULT_SRC = `${ROOT}/src`

var isDev = false

// Madskillz returns :D
const COFFEE_EXTNAMES_PATTERN = new RegExp(`\\.(${
  [...FILE_EXTENSIONS, ".cjsx"]
    .map(e => e.replace(/^\./, ""))
    .join("|")
  })$`
)

const resolveFullSrcPath = (path = DEFAULT_SRC) => (
  isAbsolute(path) ? path : resolve(ROOT, path)
)

const resolveFullDestPath = (path = ROOT) => (
  isAbsolute(path) ? path : resolve(ROOT, path)
)

const getDestFilename = (filename, src, dest) => (
  filename.replace(src, dest)
)

const isCoffee = filename => COFFEE_EXTNAMES_PATTERN.test(extname(filename))

const onContinueWatching = () => (
  console.log(cyan(pointer), "Watching for changes...")
)

function onEnd() {
  if (isDev) {
    console.log(`\n${green(tick)}`, "Done.")
  } else {
    ora.text = "Done."
    ora.succeed()
  }

  process.exit(0)
}

function onError(err) {
  if (isDev) {
    return console.log(red(cross), "Watching for changes...")
  }

  console.log(red(cross), err)
  process.exit(1)
}

function compileFile(file, enc, cb) {
  if (!isCoffee(file.path)) {
    return cb(null, file)
  }

  if (isDev) {
    console.log(cyan(pointer), `Compile ${file.path}`)
  } else {
    ora.color = "cyan"
    ora.text = `Compile ${file.path}`
  }

  try {
    const contents = compile(transform(`${file.contents}`), {
      bare: true,
      header: false,
      // sourceMap: isDev,
      sourceRoot: false,
      filename: file.path,
      sourceFiles: [file.relative],
      generatedFile: file.relative.replace(COFFEE_EXTNAMES_PATTERN, ".js")
    })

    file.contents = new Buffer(contents)
    file.path = file.path.replace(COFFEE_EXTNAMES_PATTERN, ".js")
  } catch (err) {
    return cb(err)
  }

  return cb(null, file)
}

function processFiles(files, src = DEFAULT_SRC, dest = ROOT) {
  files = files.filter(file => junk.not(file) && file !== DEFAULT_SRC)

  vfs.src(files)
    .on("error", onError)
    .pipe(through.obj(compileFile))
    .on("error", onError)
    .pipe(vfs.dest(({path}) => dirname(getDestFilename(path, src, dest))))
    .on("error", onError)
    .on("end", isDev ? onContinueWatching : onEnd)
}

function make(src, dest) {
  ora.start()

  const fulfill = (err, files) => (
    err == null ? processFiles(files, src, dest) : onError(err)
  )

  glob(`${src}/**`, fulfill)
}

function watch(src = DEFAULT_SRC, dest = ROOT) {
  isDev = true // Turning on development mode

  console.log(cyan(pointer), "Starting watcher...")
  console.log(cyan(pointer), "You can press Control+C to exit.")

  function watcher(ev, filename) {
    filename = `${src}/${filename}`

    const destFilename = getDestFilename(filename, src, dest)

    try {
      const stat = fs.statSync(filename)

      // TODO: Add recompile files in created directory (if they exists)
      if (stat.isDirectory()) {
        console.log(`Creating a directory ${filename}`)

        // Rebuild files in directory if they exists
        const fulfill = (err, files) => (
          err == null ? processFiles(files, src, dest) : onError(err)
        )

        // Find files in created directory
        const created = err => (
          err == null ? glob(`${filename}/**`, fulfill) : onError(err)
        )

        return fs.mkdir(destFilename, created)
      }

      if (isCoffee(filename)) {
        return processFiles([filename], src, dest)
      }
    } catch (err) {
      if (err.code !== "ENOENT") {
        return process.emit("error", err)
      }

      const fulfill = err => (
        err == null ? console.log(`Remove ${destFilename}`) : onError(err)
      )

      rimraf(destFilename, fulfill)
    }
  }

  // Run watcher
  fs.watch(src, {recursive: true}, watcher)
}

const actionMake = ({parent: {S, D}}) => make(
  resolveFullSrcPath(S),
  resolveFullDestPath(D)
)

const actionWatch = ({parent: {S, D}}) => watch(
  resolveFullSrcPath(S),
  resolveFullDestPath(D)
)

commander
  .command("make")
  .alias("m")
  .description("Make project")
  .action(actionMake)

commander
  .command("watch")
  .alias("w")
  .description("Run watcher for development")
  .action(actionWatch)

commander
  .option("--src, -s <directory>", "Set custom source directory")
  .option("--dest, -d <directory>", "Set custom destination directory")
  .parse(process.argv)

process
  .on("SIGINT", onEnd)
  .on("error", onError)
